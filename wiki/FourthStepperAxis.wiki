#summary The fourth stepper axis implementation for our Anliam conversion

<wiki:toc max_depth="3" />

= Introduction =
As we started to implement 4th axis capability for our mills in earnest, we acquired a 8" horizontal/vertical rotary table with a stepper motor already integrated.  This led us to transition our effort away from the servo-based fourth axis described at FourthServoAxis to a stepper-based system.  It's a testament to the flexibility of EMC2 and our implementation that this really won't cause us to change much at all with respect to the implementation.  

It will give us a chance to work out some issues associated with integrating a stepper into a servo-based system.

== Stepper driver ==
The stepper drive we are using is labled DS335, and we were able to find datasheets and some integration information for it here:

[http://www.interinar.com/ds335.html]
[http://www.interinar.com/public_docs/DS335.pdf]

It will provide up to 3.5 amps and is designed to be optimally run at 36V.  It has optically isolated inputs designed to run with no resistors at 5V, and expects step and pulse inputs as well as +5V.

== Stepper motor ==
The motor supplied is a NEMA 34 frame size stepper that otherwise has absolutely no specifications on the motor itself.  The phases are non-tapped, TODO: get Ohm resistance, and the motor seems functional with a 3.5 amp controller at ~30 volts.

== Rotary table ==
TODO: picture of the assembled table

TODO: picture of the exploded table

=== Basic mechanics ===
The rotary table we are using is a basic 8" horizontal/vertical table with a direct-drive stepper motor adapter and coupling of Chinese manufacture.  We took it apart to asses our backlash tuning options and just to see how it worked.  The table turns on ground beds that have elliptical channels for distributing the grease.

TODO: picture of the bed and turntable.

The turntable itself is held in place by a large threaded ring on the back of the turntable.  This ring is half split, presumably to provide some spring loading to hold the table in place.

TODO: picture of this nut

The table is turned by a worm drive that meshes with screw teeth around the inside perimeter of the turntable.

=== Backlash tuning ===
The worm drive has no support on the internal end and runs in a bushing whose center is eccentric, presumably to allow backlash tuning.  This bushing is held in place with a screw labeled for backlash adjustment:

TODO: picture of the backlash adjustment nut.

This nut serves no useful adjustment purpose with this device coupled to a motor, so the thumb screw should be replaced with a set screw so that the adjustment is not messed up by accident.

If this rotary table had a simple hand wheel for turning the table, this mechanism would probably be workable, but since they adapted the direct drive shaft to it, the motor coupling needs to be attached in a fixed location.  This means you can tune the backlash once via the eccentric bushing.  This was done at the factory, and then holes were drilled and tapped for the motor adapter.

Well, actually it was done three times at the factory as you can see that the holes were aligned three times and twice bolts were screwed in and ground off.  We'll have to try and determine if the current settings minimize the backlash and perhaps adjust them it they are wildly off.

You can only put so much lipstick on a pig, but we've ordered two sets of pin thrust bearings, one to replace the existing mostly frozen bicycle-style ball thrust bearings.

The second set will go on the outside of the shaft where previously a shaft collar (with a set screw that tightens directly onto the adjustment threads) just rode directly on the end of the bushing.  This should make it a bit easier to spin, increase the lifetime of the table somewhat and potentially reduce backlash to some small degree.

Once re-assembled, we can then see how little backlash we've got.  It will probably still be significant, and if so we can compensate in software.

== Motor/table integration ==
Since the system already came as an integrated unit, this was very straightforward.  The stepper shaft is attached to a coupler that drives the worm screw directly.  

The stepper motor we're using should have plenty of torque to run the table, even with the relatively lower-power stepper amp we're using.  High end speed might not be that good, but generally that is not too much of a concern for a CNC rotary table.

The coupling casting could use some refinement as well, with the crinkle coat on the end facing the table needing to be machined off and some of the access holes for set screws could be enlarged a bit for easier access.

== Electronic integration ==
The stepper 

== EMC2 configuration ==
To configure EMC2, we needed to add some stepgens to the configuration.  This can be done in pncconf.  However, since typically we'll be running in three-axis mode (XYZ), we'll make a separate configuration for a 4-axis rotary table configuration (XYZA).

We can then integrate the stepper 