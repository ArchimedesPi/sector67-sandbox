#summary A page describing integration of the Huanyang 3HP VFD

= Introduction =
Around 8/2012 Sector67 began an effort to integrate a Huanyang 3HP VFP inverter to control the spindle on our older CNC mill.  This page describes some details of that integration.

This integration is in progress so this page is a placeholder for now.

There were several strategies for integrating the spindle control with the overall LinuxCNC-based system, including
  * Use analog output from the MESA cards and encoder input, along with the analog input functions of the VFD to implement full control of the spindle via LinuxCNC.  This would ultimately be interesting and allow rigid tapping, but as we have little need for that and typically tweak the spindle speed by hand (and sometimes run the mill in completely manual mode) we did not choose this path.
  * Use of the "Digital Operator" front panel on the VFD.  This could be extended to the front of the machine.  The interface is a bit clunky for newcomers however and is not very rugged, so we did not pursue this approach either.
  * Integration to LinuxCNC via RS485.  This would require some software tweaking but would be simpler than implementing a full control loop.  Again though the desire to use the spindle in manual mode precluded this path.
  * Use of the existing rugged analog control panel.  This panel has a potentimeter for RPM adjustment, an enable switch, a forward/reverse switch and a digital RPM display.  It also has a relay for latching estop functions.

We chose the existing analog control panel approach as it provided the most rugged interface that could be manually controlled.  This might be revisited in the future, especially integrating an encoder with LinuxCNC to provide accurate RPM.

= Issues =
  * The screw terminals on the VFP are fairly small for the expected current.  We had to grind down the sides of 10 gauge crimp terminal ends to be able to fit them into the terminals on the device.

  * The terminal labeled +5V seems to be high impedence and does not supply +5V.  This causes a re-work of the enable latching circuit because the existing relay was rated for 5v.  Luckily Chris had 24V CPDT relays handy.  The +5V is not documented on some of the diagrams in the manual, but is clearly labeld on the terminals, so this is a bit of a mystery.  I have not been able to find a setting that would "enable" the +5V output.  The corresponding 24V output works as expected.

  * The forward/reverse switch did not function as expected.  It had four terminals and three positions (forward, stop, reverse).  I had assumed this switch was single pole double throw and would have one pair open in the forward position and one pair closed, reversing that for the reverse position and both pairs open in the off position.  It turns out it had both pairs open in the off position, one pair closed in the reverse position and both pairs closed in the forward position.  There was no obvious way to make this switch scheme compatible with the input the VFD expected, so we had to switch to a different forward/off/reverse switch.  Chris had a switch in stock that worked as expected (Sector67 is amazing!).

= Details =

A table of changed settings
(this table is neither complete not correct currently)
|| Settings || Factory || Set to || Meaning ||
|| PD002    || 0       || 1      || Operating frequencies controlled via external terminals ||
|| PD030    || 0.0     || 5.0    || DC braking time at stop ||
|| PD031    || 2.0     || ?      || Increase slowly if braking does not stop the device. ||
|| PD026    || 0       || 1      || Coasting stop (enables braking) ||
|| PD028    || 0.5     || ?      || Stopping frequency.  Increase to apply braking sooner ||
|| PD047    || 07      || 09     || Configure input #4 (SPH) as an external estop ||
|| PD048    || 19      || 09     || Configure input #5 (SPL) as an external estop ||
|| PD051    || 03      || 03     || Confirm Y2 output is fault indication.||

= References =
A wiring diagram for the HH Roberts analog control panel can be found here:

http://www.hhrobertsmachinery.com/HHRM-docs/Topwell/GL%20220V%20Head%20Replacment%20Manual%20Rev%204A.pdf

or

http://www.hhrobertsmachinery.com/Support/Manual_machine_Parts_Lists/Yaskawa/GL%20Yaskawa.JPG

The manual for the VFD can be found here:

http://www.cnczone.com/forums/attachment.php?attachmentid=79285&d=1239132143

= Wires from the control head =

||Wire  ||VFD Side        ||Control head side   ||
||Gray  || Sindle lock    ||
||Purple|| REV            ||
||Orange|| FOR            ||
||Brown || ACM            || Ground of speed POT and digital tach || Analog ground signal
||Tan   || 10V            || Top of speed POT || +10V reference for speed control ||
||Pink  || V0             || + signal of digital tach || Analog speed out
||Red   || +24V           ||                    || +24V for latch circuit
||Black || VI             || Wiper of speed POT || Analog speed signal in 

= Wires from spindle lock =

Spindle lock is normally closed, open when the spindle is locked
|| Wire || Use ||
|| Red || Gray signal wire to complete ground circuit. 
|| Black || DCM || || 
= TODO =
TODO:
* Test the 5V output and see if it is enabled when the input is 5V.
* Integrate the spindle lock as an external estop
* Integrate the LinuxCNC estop as an external estop (parallel)
* Integrate the fault out into LinuxCNC
* Shrink wrap and mount the 24V relay
* Wire the RPM display and calibrate
* Re-crimp the fan and re-lable it properly as 220V