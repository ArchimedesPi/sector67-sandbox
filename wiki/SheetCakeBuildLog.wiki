#summary The project sheet cake build log

= Introduction =

A build log of the ProjectSheetCake project.

<wiki:toc max_depth="2" />

== 8/11/2011: Initial testing of the integration board ==
Scott:

I had some time tonight to finally make earnest progress on testing the integration board.  Chris had allocated a PC for EMC2, and I was able to:

  * Added another prototype perf board to the integration board for the LED indicators
  * Changed one of the standoffs to be plastic as it was hitting a solder bridge.
  * Soldered in wires for the servo enable and servo reset output signals and attached those wires to the screw terminals.
  * Install the PCI card (with 50 pin ribbon cables repurposed from SCSI cables with the active terminators removed) into the EMC2 PC.
  * Boot the PC with an EMC2 live CD and install Ubuntu+EMC2 to the hard drive
  * Confirm via the Synaptic Package Manager that the hostmot2 packages were already installed
  * Run EMC2 (Applications -> CNC -> EMC2) and choose a configuration of (hm2-servo -> 5i23).  I chose to create a desktop icon for this install.
  * Temporarily install the integration board to the mill and hook up the encoder DB9 connectors
  * Confirm that moving the mill manually was reflected properly in EMC2!!!  This means that the encoder wiring through the DB9 ports to the 7i33 daughter card to the 5i23 PCI card is basically correct.  There are a lot of things that could have gone wrong here, but all three axes appear to work correctly, and I even guessed right on the A/B encoder signals :-).
  * Chris and I then attempted to move the Z axis servo via EMC2.  I switched the header from the Anilam board to the integration board, and the Z axes moved properly (although not tuned) with manual commands from EMC2.  Note that the estop and servo enable circuits were still being handled by the Anilam board.  Occasionally got following errors on the Z axis, and it is clearly moving further than EMC2 thinks it is moving, but the basics are there.  Great success!!!
  * Tried the same with X and Y, and had less success.  I moved the X and Y headers to the integration board, and had following errors soon after "machine on" in EMC2 on the X axis without even attempting to move the axis.  The X axis was actually moving when not commanded to.  I'm not sure if this is due to ground differences between the integration board, etc. but that will need to be determined.
  * There was an error in dmesg about too much jitter, and so I ran the jitter test and indeed the machine did not perform well (8,000,000ns+ jitter).

Things that came up tonight as future to-dos:

  * Get a PC with better real time performance
  * Get a PS2 mouse so that we can have both PCs working at the same time using the 2-PC KVM switch.
  * Get an Ethernet connection provisioned to that corner for the 1100m machine so that we can email files, etc.
  * Solder up LED indicator board for the integration board.
  * Try the estop circuit with the integration board

== 8/14/2011: Integration board LED indicators ==
Laura, the boys and I worked on the integration board a bit this evening, soldering up an LED indicator board which will give a visual indication of limit state, estop state, etc.  Luke did a great job soldering and Levi did a great job placing components on the proto board.  Luke does a cleaner job of soldering than I do, and I got to show him how to make a solder bridge on a perforated proto board.

== 8/14/2011: Additional testing of the integration board, EMC2 configuration ==
Good progress made this evening:
  * The integration board hardware is nearly in a complete state.  The LED indicators now fully work
  * I changed the power management settings on the Compaq W6000 PC, and that had a major positive impact on the jitter results, going from > 8,000,000 to < 20,000.  This is great news as it moves the PC from unusable for EMC2 whatsoever, to working very well for both servo and stepper configurations.
  * I used pncconf for the first time and have found this to be a very helpful tool.  The X and Y were switched relative to what I would expect when configuring the axes, as were A and Z.  Other than that (and pushing through setting bogus values for tuning), it generated a working config for the servo controllers (but not IO yet).
  * The servo enable LED was not functioning correctly, and I figured out why.  The input of the relay I was using to indicate servo enabled was at 24V and I was expecting it to be ground until it was energized.  I needed to switch that LED to have +24v supplied from the rail and to get ground when energized.  This LED then worked properly
  * I did my first testing with the entire board (motion and servo enable sides) hooked up.  Anilam complained about not seeing the board, but I was able to get the servos enabled by shorting the servo enable OUT1+ to OUT1- and temporarily shorting the servo reset (OUT3+ to OUT3-) so the integration board circuits themselves seem to be functioning well, I just need to fix:
  * I cannot yet get I/O to work properly.   I'm not sure at what level I'm having a problem; cable, HAL, etc.  I need to learn more about this.
  * The second critical problem I continue to have is following error when the servos should be still.  When I enabled the servos manually by shorting pins, both the X and Z axis appeared (based on the EMC2 display) to be moving tiny fractions of an inch basically continuously.  I'm not sure if this is an encoder or control signal error, some sort of servo tuning needed or some software tuning/compensation, but I need to understand that better as well.
  * TODO: I should switch to powering the EMC2 server from the same outlet as the mill so that I can rule out ground difference problems.
  * Discovered that the HAL manual has decent documentation of halmeter and halscope, so I'll dig into those the next change I get, as they might be useful do debug both the I/O not working issue and the following error when the servos are enabled.
  * One idea I had was to configure the system with 4 servos and 2 steppers, so that eventually if we use some steppers we won't be stepping on the same I/O pins that would be used by the stepper configuration.  This might mean changing the current I/O assignments to the integration board, but in the long run would support running steppers more easily.

Seems like the next tasks with respect to integration of the "custom" Anilam servo reset functionality are:

  * Generate a pyvcp custom panel for servo reset at least
  * And the corresponding HAL configuration for a servo reset pin
  * Integrate it into the axis GUI

== 8/16/2011: I/O working! ==
Scott:

Tonight Luke and I were able to put some finishing touches on the integration board.  Estop input was soldered up, and pcnconf was used to make the input work.  I did indeed have the pins wrong in pncconf as I was using the wrong pin numbers from the 7i37TA data sheet.  I was using the pin number in the output header (1 and 3), and I needed to be using the pin number of the input to the card (35 and 39).  The outputs needed to be inverted, as well as the estop input.  After that, servo enable and servo reset (temporarily configured as spindle ccw so I have a button for it already) worked great.  So, problem #1 is basically solved, and estop in works fine as a bonus.

I moved the PC on top of the controller box as a more convenient location for it.

I still have the problem of the servos not sitting still, though.  In pncconf I believe that proper direction of the table required inverting the servo amp output, but still the servos were not stable.  I plan to send a query to the emc-users mailing list about this to see if anyone else has encountered it.  I want to get the board schematic online first though, so people can understand the integration board.

Some next steps:

  * Test adding an extra widget to the axis GUI using pyVCP to provide a "Servo Reset" button.
  * Email EMC2 users group regarding unstable servos
  * Investigate the spindle head to see how best to control that and start designing a spindle controller interface
  * Figure out the X, Y and Z axis scales so that we have the distances correct.
