#summary The project sheet cake build log

= Introduction =

A build log of the ProjectSheetCake project.

<wiki:toc max_depth="2" />

== 8/11/2011: Initial testing of the integration board ==
Scott:

I had some time tonight to finally make earnest progress on testing the integration board.  Chris had allocated a PC for EMC2, and I was able to:

  * Added another prototype perf board to the integration board for the LED indicators
  * Changed one of the standoffs to be plastic as it was hitting a solder bridge.
  * Soldered in wires for the servo enable and servo reset output signals and attached those wires to the screw terminals.
  * Install the PCI card (with 50 pin ribbon cables repurposed from SCSI cables with the active terminators removed) into the EMC2 PC.
  * Boot the PC with an EMC2 live CD and install Ubuntu+EMC2 to the hard drive
  * Confirm via the Synaptic Package Manager that the hostmot2 packages were already installed
  * Run EMC2 (Applications -> CNC -> EMC2) and choose a configuration of (hm2-servo -> 5i23).  I chose to create a desktop icon for this install.
  * Temporarily install the integration board to the mill and hook up the encoder DB9 connectors
  * Confirm that moving the mill manually was reflected properly in EMC2!!!  This means that the encoder wiring through the DB9 ports to the 7i33 daughter card to the 5i23 PCI card is basically correct.  There are a lot of things that could have gone wrong here, but all three axes appear to work correctly, and I even guessed right on the A/B encoder signals :-).
  * Chris and I then attempted to move the Z axis servo via EMC2.  I switched the header from the Anilam board to the integration board, and the Z axes moved properly (although not tuned) with manual commands from EMC2.  Note that the estop and servo enable circuits were still being handled by the Anilam board.  Occasionally got following errors on the Z axis, and it is clearly moving further than EMC2 thinks it is moving, but the basics are there.  Great success!!!
  * Tried the same with X and Y, and had less success.  I moved the X and Y headers to the integration board, and had following errors soon after "machine on" in EMC2 on the X axis without even attempting to move the axis.  The X axis was actually moving when not commanded to.  I'm not sure if this is due to ground differences between the integration board, etc. but that will need to be determined.
  * There was an error in dmesg about too much jitter, and so I ran the jitter test and indeed the machine did not perform well (8,000,000ns+ jitter).

Things that came up tonight as future to-dos:

  * Get a PC with better real time performance
  * Get a PS2 mouse so that we can have both PCs working at the same time using the 2-PC KVM switch.
  * Get an Ethernet connection provisioned to that corner for the 1100m machine so that we can email files, etc.
  * Solder up LED indicator board for the integration board.
  * Try the estop circuit with the integration board

== 8/14/2011: Integration board LED indicators ==
Laura, the boys and I worked on the integration board a bit this evening, soldering up an LED indicator board which will give a visual indication of limit state, estop state, etc.  Luke did a great job soldering and Levi did a great job placing components on the proto board.  Luke does a cleaner job of soldering than I do, and I got to show him how to make a solder bridge on a perforated proto board.

== 8/14/2011: Additional testing of the integration board, EMC2 configuration ==
Good progress made this evening:
  * The integration board hardware is nearly in a complete state.  The LED indicators now fully work
  * I changed the power management settings on the Compaq W6000 PC, and that had a major positive impact on the jitter results, going from > 8,000,000 to < 20,000.  This is great news as it moves the PC from unusable for EMC2 whatsoever, to working very well for both servo and stepper configurations.
  * I used pncconf for the first time and have found this to be a very helpful tool.  The X and Y were switched relative to what I would expect when configuring the axes, as were A and Z.  Other than that (and pushing through setting bogus values for tuning), it generated a working config for the servo controllers (but not IO yet).
  * The servo enable LED was not functioning correctly, and I figured out why.  The input of the relay I was using to indicate servo enabled was at 24V and I was expecting it to be ground until it was energized.  I needed to switch that LED to have +24v supplied from the rail and to get ground when energized.  This LED then worked properly
  * I did my first testing with the entire board (motion and servo enable sides) hooked up.  Anilam complained about not seeing the board, but I was able to get the servos enabled by shorting the servo enable OUT1+ to OUT1- and temporarily shorting the servo reset (OUT3+ to OUT3-) so the integration board circuits themselves seem to be functioning well, I just need to fix:
  * I cannot yet get I/O to work properly.   I'm not sure at what level I'm having a problem; cable, HAL, etc.  I need to learn more about this.
  * The second critical problem I continue to have is following error when the servos should be still.  When I enabled the servos manually by shorting pins, both the X and Z axis appeared (based on the EMC2 display) to be moving tiny fractions of an inch basically continuously.  I'm not sure if this is an encoder or control signal error, some sort of servo tuning needed or some software tuning/compensation, but I need to understand that better as well.
  * TODO: I should switch to powering the EMC2 server from the same outlet as the mill so that I can rule out ground difference problems.
  * Discovered that the HAL manual has decent documentation of halmeter and halscope, so I'll dig into those the next change I get, as they might be useful do debug both the I/O not working issue and the following error when the servos are enabled.
  * One idea I had was to configure the system with 4 servos and 2 steppers, so that eventually if we use some steppers we won't be stepping on the same I/O pins that would be used by the stepper configuration.  This might mean changing the current I/O assignments to the integration board, but in the long run would support running steppers more easily.

Seems like the next tasks with respect to integration of the "custom" Anilam servo reset functionality are:

  * Generate a pyvcp custom panel for servo reset at least
  * And the corresponding HAL configuration for a servo reset pin
  * Integrate it into the axis GUI

== 8/16/2011: I/O working! ==
Scott:

Tonight Luke and I were able to put some finishing touches on the integration board.  Estop input was soldered up, and pcnconf was used to make the input work.  I did indeed have the pins wrong in pncconf as I was using the wrong pin numbers from the 7i37TA data sheet.  I was using the pin number in the output header (1 and 3), and I needed to be using the pin number of the input to the card (35 and 39).  The outputs needed to be inverted, as well as the estop input.  After that, servo enable and servo reset (temporarily configured as spindle ccw so I have a button for it already) worked great.  So, problem #1 is basically solved, and estop in works fine as a bonus.

I moved the PC on top of the controller box as a more convenient location for it.

I still have the problem of the servos not sitting still, though.  In pncconf I believe that proper direction of the table required inverting the servo amp output, but still the servos were not stable.  I plan to send a query to the emc-users mailing list about this to see if anyone else has encountered it.  I want to get the board schematic online first though, so people can understand the integration board.

Some next steps:

  * Test adding an extra widget to the axis GUI using pyVCP to provide a "Servo Reset" button.
  * Email EMC2 users group regarding unstable servos
  * Investigate the spindle head to see how best to control that and start designing a spindle controller interface
  * Figure out the X, Y and Z axis scales so that we have the distances correct.

== 8/17/2011: An afternoon of frustration ==
I was unable to make any headway against the servo stability issue, so I gathered some data and updated my question to the mailing list.  I did work out the encoder count is 1500 and threads per inch on the X axis lead screw is 5.

== 8/17/2011: Basic servo stability, and first gcode run ==
After working through a diagnostic procedure to make sure voltage levels, etc. were all correct, it turns out I was hitting a bug in pncconf 2.4.3 where inverting an axis also caused the max_output parameter in the ini file to be set negative when it should actually be positive.  Manually changing the max_output to be positive got the axes relatively stable, and some additional PID tuning got it to the point where I was able to run a gcode program through without problems.

This problem forced me to dig a bit more into the EMC2 internals and as such was a good learning exercise.  I'm glad in the end it wasn't a hardware problem but ultimately a relatively simple software one.

A lot more tuning is needed, including properly calibrating the axes, determine what we can do for acceleration, and many other things, and that will all take some time, but the system is now basically functional as a mill again.

I did realize I had some axes crossed in the integration board, so I rewired those and will be updating the schematic to reflect the change.

I also realized the only reason we needed the in-chassis 5, +/-15V power supply was to drive the LED indicating it is working, so I'll be removing that from the board design, and relying on cable power (per a recommendation from Mesa to prefer that unless the drop is too much) to power the daughter boards.

So, moving forward the next steps for the mill controller are:

  * Get all axes calibrates so that we really know how much we're moving
  * Figure out maximum velocity and acceleration for the axes
  * Add a servo reset custom button (David is working on this)
  * Spend some quality time tuning the axes for real for better and higher performance
  * Set the following error back to a reasonable and safer level
  * Configure the table axes limits properly

I realized that when I calculated the encoder ticks, I was turning the handle one turn, but that was including the gear ratio in the measured value.  That means the numbers from the Anilam configuration now make much more sense.

== 8/23/2011: servo reset automation investigation ==
I was "faking" a servo reset button with the spindle CW output pin, and had the rude realization that if I left servo reset on, if the machine when to a limit switch, when I manually recovered it it would head back into enable mode and potentially start spinning the servos again.  There are really two deficiencies here that combined to make this unsafe behavior:

1) The servo reset out should not be able to be constantly enabled.  Instead, it should either be a momentary enable push button, or it could also be an automatic ~1s pulse on machine on.  David is working on the push button approach with PyVCP, and I have started investigations of the automated solution using ladder logic.

2) When the machine hits a limit switch, it should put the machine into the estop state.  The way the latching circuit works, it will be somewhat complicated to have a single "NO_FAULT" type signal.  However, an extra input pin could be used to provide the "ALL_LIMITS_OK" signal to EMC2, and then hook that up to a ladder program to go to an estop state.  I am somewhat surprised pncconf does not have a ready-made input for limit switches (I have till now told it not to home, etc.), and it is possible it does, so I'll investigate.  It appears I just need to tell pncconf that there are physical limit switches, but no home switches, and then see if it gives me a pin to hook up.  I expect it will.  I'll then need to solder wires to the ALL_LIMIT_OK signal, and likely have it inverted in EMC2 to work properly.

Both of these really should be done in the interest of safety.

In addition, I have been curious about adding additional stepper motors to this system, but have noticed that when adding stepgens using pncconf that they are mapped to pins that are not output pins in the isolated I/O card.  According to documentation here:

http://blog.gmane.org/gmane.linux.distributions.emc.devel

This might mean that stepgens are relatively difficult to use with the isolated I/O card (without remapping the cable), and that I should put general purpose I/O on the third connector, and leave connector #2 for stepgens.  Alternatively, I could make a cable that would remap the pins appropriately, but that might be more confusing than it is worth.  I expect that servo drivers take ttl directly and do not need isolated I/O.

== 8/25/2011: a productive night at S67 ==
I spend most of the evening at S67 tonight working on this project.  I made a lot of progress, including:
  * Took the board out and soldered wires for the limit switches and attached them to an input pin
  * Got some pictures of the integration board with my camera phone (forgot a better camera).
  * Re-ordered the 50 pin cables so that custom I/O is using the last 50 pin cable in case we want to use stepgens which automatically get put to specific pins on board 2 that are not compatible with the isolated I/O card.  Looks like I bought one too many isolated I/O cards.  Perhaps if we convert the 3300 mill :-).  The stepper controllers for stepgens would need to take TTL level signals, which should be fine.
  * Upgraded to EMC 2.4.6 via buildbot.linuxcnc.org and confirmed the MAX_OUTPUT bug is fixed.
  * Measured axis values to determine X, Y, Z scales of 30000, 30000 and 36000.  Output is now scaled correctly, but I'm not sure why that doesn't add up to what Anilam was using for config.
  * Used the new pncconf to re-generate the configuration, fixing following error, max velocity, acceleration, encoder scaling so that the mill is basically a stable mover now and should be basically accurate.
  * Did some investigation of PID tuning, but only preliminary
  * Drilled holes in the back of the integration board for eventual mounting (7/32" holes 8 3/8" apart centered on the board).  Slots might be easier to install, but holes were easier to make.
  * Put numerous generations of the configuration under revision control.
  * Implemented a timed servo reset classic ladder program that seems to work as expected.  This, along with the limit switch addition should make things easier and safer.  It took some debugging to get it integrated via pncconf.  pncconf was not adding custom.hal to the ini file hal entries for some reason, even when seemingly requested to do so.
  * Speaking of which, hooking up an all axis limit switch was easy, and now the machine realizes is has hit a limit switch and stops on its own (in addition to the hardware switches stopping the servos).  The limit switch did not need to be inverted in pncconf, as it is a signal that indicates the limit was hit.
  * Re-ran the EMC2.4AXIS program with a sharpie with the correct scaling.  Looks great, and can't wait to run a real program.

Now to-do:
  * PID tuning as needed for all axis
  * Send an email to the list as to why I am getting consistent following error
  * Try a USB joystick for jogging.
  * Try a relay on the isolated I/O, how to hook this up to custom gcode?
  * Disable ubuntu update to it is not prompting to update packages, which might break EMC2
  * Document most of what I did tonight in earnest
  * Note to the list about pncconf not including HAL ini entries for custom.hal and custom_postgui.hal (get emc2 version for this)
  * Document the relay board pins in the wiki
  * Document the relay board circuit in KiCad

I probably should start in on the frosting extrusion problem, but in any case probably won't get that done by Aug 31.