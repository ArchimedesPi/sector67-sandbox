=Project Sheet Cake=
A three-axis CNC Mill Conversion from Anilam 1100 controls to EMC2

==Introduction==
In 2010, Sector67 (http://www.sector67.org) acquired two CNC mills, one with an Anilam 1100 control system and one with an Anilam 3300 control system.  At the time the CNC portion of the 3300 mill was non-functional but since then both of the mills have been brought into use and have generally been workhorses, with the 1100 mill being used primarily.  Although the Anilam 1100 system overall is somewhat dated, it has provided the needed functionality for many members to start down the path of CNC mastery.  We have worked to extend the existing system for our needs, writing a standalone Anilam post processor for converting abitrarily large gcode files in the most accurate way possible:

http://code.google.com/p/sector67-sandbox/wiki/AnilamPostProcessor

and a Python-based DNC program for running large programs via the serial port:

http://code.google.com/p/sector67-sandbox/wiki/AnilamPostProcessor

as we look to make best use of these mills in the hackerspace, we are hitting some of the limitations of the Anilam system.  In parallel other members have been developing our capability to perform 3D printing including building and tuning a couple of CupCake CNC systems and working on plastic extrusion print head issues.  Debugging some of these print issues led to a discussion around print head stability, and the potential to use our CNC mills as a 3D printing platform.

The Anilam control system is unfortunately not well suited for extension to additional axis and arbitrary machine and motion control.  However, the servos, servo controllers, spindle and other portions of the mill are rock solid, which led us to think of converting the mill to make use of more modern hardware and software that could more easily be adapted to the various sorts of arbitary precision machine control needs that might come up at a hackerspace.  Specifically, of course, decorating a sheet cake.

So, in the spirit of the CupCake CNC, which is named for the approximate size of artifact it can create, we have dubbed our CNC mill conversion project "Project Sheet Cake".

==Choosing control hardware and software==
When looking at possible choices for updated software and hardware, two software choices in particular were contenders.  [http://linuxcnc.org/ EMC2] and Mach3 both have large groups of adherents and active development work ongoing.  However, for control of our servo system, EMC2 makes more sense as Mach3 is geared toward bit-blasting stepper systems.  If we wanted to control the servos via Mach3, we'd need a hardware-based solution to manage the servo encoder feedback loop.

In addition, EMC2 is open source software which in many ways better fits the hackerspace ethic.

With respect to the interface hardware, a couple of folks had already done conversions of the scale we were considering using hardware from Mesa Electronics (http://mesanet.com).  Although they offer no discount to hackerspaces, support for their hardware in EMC2 is very mature, and their costs in any case are on the lower side of the servo-capable interface hardware.  The fact that their PCI cards are arbitrary I/O cards based on Xilinx FPGA will hopefully give us as much flexibility as we could want.

Specifically, we have chosen the following boards from [http://mesanet.com Mesa]:

  * A [http://mesanet.com/pdf/parallel/5i23man.pdf 5I23] FPGA based PCI  Anything I/O card.  This card will go in the PC, and 50 pin ribbon cables will provide signals to the daughter cards.  Currently $229 in small quantities.

  * A [http://mesanet.com/pdf/motion/7i33man.pdf 7i33TA] quad analog servo interface daughter card.  This card will be wired to provide the servo amps with the appropriate +/-10V input signals, and take the encoder signals in and clean them up for EMC2.  Currently $79 in small quantities.

  * A [http://mesanet.com/pdf/parallel/7i37man.pdf 7i37TA] isolated I/O daughter card.  This card will be used to provide isolated output from EMC2 for the servo enable and servo reset signals (amongst other things), and to provide input of some machine state to EMC2.  Currently $79 in small quantities.

==Understanding the Anilam 1100 servo enable circuit==

The server enable circuit is basically a set of four relays that are used to provide 120VAC to the servo power supply and power to the spindle relay.

Although it would be possible to run the estop and limit functions completely in software with emc2, we are choosing to preserve the existing hardware solution, with machine state being read by emc2.

Since our mill does not have separate limit/home switches, this effectively means that we will not be able automatically home to a machine absolute zero.  However, since nearly all of our milling is currently done relative to a local zero this will hopefully not be a severe limit.  With so many different users using the mill, and potentially even working on the emc2 software, a hardware hard limit seemed like the more prudent decision.  Separate home switches could be added in the future if that feature is needed.

Each axis has a set of limit switches that are wired in series, along with an DPST (double pole single throw) estop button.  These switches are all normally closed, and provide part of the 24V ground circuit for the bottom two (as viewed in the box) relays on the relay board.

The relays are:

K4: Top relay, enabled state represents servo enable, 
Ground path controlled by the PC "servo enable" flag.  
When energized helps complete the ground path for K1 and K3.

K1: Middle relay, active output facilitates the latching circuit by providing the ground circuit to itself
Ground path controlled by (in series):

  * The limit switches
  * The estop button
  * The K1 relay being energized and/or the SERVO_RESET path enabled.  
  * The K4 relay being energized

When energized, helps completes the ground path for K1 and K3
The closed when non-energized portion of this relay controlls the "servo off" signal to the PC.
SERVO_RESET is meant to be temporarily engergized to allow the latch state to be set up.  It should then be disabled so that if the ground path is broken via the limit switches, estop, etc., K1 will be de-energized. 

K3: Bottom relay
Ground path is the same as K1
When energized drives the K2 solid state relay on the back side of the board to enable the spindle relay and provide 120VAC to the servo amp power supply.





Signals to the PC:
SERVO_OFF
X_LIMIT
Y_LIMIT
Z_LIMIT
DEAD_STOP_OK
E_STOP_OK
SERVO_RESET_IN
MANUAL ?
 
Signals from the PC:
SERVO_ENABLE: When active specifies that the servos should be enabled
SERVO_RESET: When active allows ground to temporarily flow past the K1 relay to allow K1 to energize and set up the latched circuit.
E_STOP: A part of the estop circuit.  Needs to be active to allow the servos to energize.  Allows for a software estop.


The signals from the PC will need to be mapped to pins within EMC2.  Normally, EMC2 manages a "MACHINE_ON" and TODO: get signal..., and these can be mapped in the following way:

a separate SERVO_RESET will need to be created and managed via the EMC2 software.  This could be done via a normally open hardware button as well (or even making use of the existing ANILAM console servo reset button), but managing it in software seems to be the most straightforward method of managing this signal.  When this signal is momentarily enabled, it allows the latching circuit to be set up.


==Creating the necessary interface hardware==
Some hardware will be needed to interface the existing servo amp, servo enalble and estop functions to the Mesa daughter boards.  One of the primary goals with this hardware was to make it plug-compatible with the existing chassis so that we can easily switch between control systems as necessary. 

TODO: complete documentation of this board and how it is wired.


==Installing EMC2==

==Configuring EMC2==

==Tuning EMC2==


==Integrating additional control capability==